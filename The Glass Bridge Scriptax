-- Attempt to load Rayfield library from sirius.menu
local success, Rayfield = pcall(function()
    return loadstring(game:HttpGet('https://sirius.menu/rayfield'))()
end)

-- Check if Rayfield loaded successfully
if not success or not Rayfield then
    warn("Failed to load Rayfield from https://sirius.menu/rayfield. Running script without UI.")
    -- Fallback script without UI (optimizado: solo modelos con glass_tempered)
    local cachedSteps = {}
    for _, step in ipairs(workspace:GetChildren()) do
        if step:IsA("Model") and step:FindFirstChild("glass_tempered") then
            table.insert(cachedSteps, step)
        end
    end
    for _, step in ipairs(cachedSteps) do
        local glassTempered = step:FindFirstChild("glass_tempered")
        if glassTempered then
            for _, part in ipairs(glassTempered:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    part.Color = Color3.fromRGB(0, 255, 0) -- Neon green
                    part.Material = Enum.Material.Neon
                end
            end
        end
    end
    print("Coloring completed: glass_tempered (neon green) via cache.")
else
    -- Show decorative notification on script start
    Rayfield:Notify({
        Title = "Scriptax HUB",
        Content = "Welcome to Scriptax HUB! Glass Color Menu loaded (crash-proof, auto-reapply ESP).",
        Duration = 4,
        Image = "rbxassetid://4483345998"
    })

    -- Services
    local Players = game:GetService("Players")
    local LocalPlayer = Players.LocalPlayer
    local UserInputService = game:GetService("UserInputService")
    local RunService = game:GetService("RunService")

    -- Function to create the window
    local function createWindow()
        local Window = Rayfield:CreateWindow({
            Name = "Glass Color Menu | Scriptax",
            LoadingTitle = "Loading...",
            LoadingSubtitle = "by Estardax",
            ShowText = "Open Menu",
            Theme = "Serenity",
            ToggleUIKeybind = "G",
            KeySystem = false,
            ConfigurationSaving = { 
                Enabled = true, 
                FolderName = "ScriptaxConfig", 
                FileName = "GlassColorConfig" 
            }
        })

        -- ================== SHARED VARS ==================
        local glassEspEnabled = false
        local originalTempered = {} -- [part] = {Color=..., Material=...}
        local cachedSteps = {} -- Cache de modelos con glass_tempered
        local cachedTemperedParts = {} -- Sub-cache de parts para ESP
        local GlassEspToggle = nil -- Reference to Glass ESP toggle
        local DebugLagToggle = nil -- Opcional: Para medir lag
        local floatingEspButton = nil -- Reference to the ESP floating button UI
        local floatingCorrectButton = nil -- Reference to the Correct All floating button UI
        local floatingEspButtonToggle = nil -- Reference to the ESP mobile toggle
        local floatingCorrectButtonToggle = nil -- Reference to the Correct All mobile toggle
        local espStroke = nil -- Reference to the ESP UIStroke for borders
        local correctStroke = nil -- Reference to the Correct All UIStroke for borders
        
        -- ChildAdded connection for dynamic steps (crash-proof con retries)
        local childAddedConnection = workspace.ChildAdded:Connect(function(child)
            if child:IsA("Model") and child:FindFirstChild("glass_tempered") then
                if glassEspEnabled then
                    pcall(function()
                        cacheAndApplyToStepEsp(child)
                    end)
                end
            end
        end)

        -- Heartbeat optimizado: Chequea cada 3.5s, solo si cache cambió
        local lastCheckTime = 0
        local checkInterval = 3.5 -- Balance entre rapidez y bajo impacto
        local previousStepCount = 0
        RunService.Heartbeat:Connect(function()
            if glassEspEnabled and os.clock() - lastCheckTime >= checkInterval then
                lastCheckTime = os.clock()
                local currentCount = #cachedSteps
                if currentCount ~= previousStepCount then
                    previousStepCount = currentCount
                    pcall(function()
                        updateEspCache()
                        if DebugLagToggle and DebugLagToggle.CurrentValue then
                            local startTime = os.clock()
                            applyCachedEsp()
                            print("Debug Lag: ESP reaplicación tomó " .. (os.clock() - startTime) * 1000 .. " ms")
                        else
                            applyCachedEsp()
                        end
                    end)
                end
            end
        end)

        -- Función para cachear y aplicar ESP a un Step (crash-proof con retries)
        local function cacheAndApplyToStepEsp(step)
            if not step or not step:IsDescendantOf(workspace) then return end
            local glassTempered = step:FindFirstChild("glass_tempered")
            local retries = 0
            while not glassTempered and retries < 3 do
                task.wait(0.2)
                glassTempered = step:FindFirstChild("glass_tempered")
                retries = retries + 1
            end
            if not glassTempered then
                if DebugLagToggle and DebugLagToggle.CurrentValue then
                    print("Debug: Step " .. step.Name .. " no tiene glass_tempered tras retries")
                end
                return
            end
            local stepIndex = #cachedSteps + 1
            cachedSteps[stepIndex] = step
            local parts = {}
            cachedTemperedParts[stepIndex] = parts
            for _, part in ipairs(glassTempered:GetDescendants()) do
                if part:IsA("BasePart") or part:IsA("MeshPart") then
                    if not originalTempered[part] then
                        originalTempered[part] = { Color = part.Color, Material = part.Material }
                    end
                    part.Color = Color3.fromRGB(0, 255, 0) -- Neon green
                    part.Material = Enum.Material.Neon
                    table.insert(parts, part)
                end
            end
        end

        -- Actualiza cache completo
        local function updateEspCache()
            cachedSteps = {}
            cachedTemperedParts = {}
            for _, step in ipairs(workspace:GetChildren()) do
                if step:IsA("Model") and step:FindFirstChild("glass_tempered") then
                    pcall(function()
                        cacheAndApplyToStepEsp(step)
                    end)
                end
            end
        end

        -- Aplica ESP solo a parts cacheadas
        local function applyCachedEsp()
            for i, parts in ipairs(cachedTemperedParts) do
                local step = cachedSteps[i]
                if step and step:IsDescendantOf(workspace) then
                    for _, part in ipairs(parts) do
                        if part and part:IsDescendantOf(workspace) then
                            if not originalTempered[part] then
                                originalTempered[part] = { Color = part.Color, Material = part.Material }
                            end
                            part.Color = Color3.fromRGB(0, 255, 0)
                            part.Material = Enum.Material.Neon
                        end
                    end
                else
                    cachedSteps[i] = nil
                    cachedTemperedParts[i] = nil
                end
            end
        end

        -- Correct All (optimizado con cache one-time)
        local function executeCorrectAll()
            local startTime = tick()
            local tempSteps = {}
            for _, step in ipairs(workspace:GetChildren()) do
                if step:IsA("Model") and step:FindFirstChild("glass_weak") then
                    table.insert(tempSteps, step)
                end
            end
            for _, step in ipairs(tempSteps) do
                pcall(function()
                    local glassWeak = step:FindFirstChild("glass_weak")
                    if glassWeak then
                        for _, part in ipairs(glassWeak:GetDescendants()) do
                            if part:IsA("BasePart") or part:IsA("MeshPart") then
                                part.Color = Color3.fromRGB(0, 0, 255) -- Blue
                                part.Material = Enum.Material.Neon
                            end
                        end
                        local detector = glassWeak:FindFirstChild("Detector")
                        if detector then
                            detector:Destroy()
                        end
                    end
                end)
            end
            if DebugLagToggle and DebugLagToggle.CurrentValue then
                print("Debug Lag: Correct All tomó " .. (tick() - startTime) * 1000 .. " ms para " .. #tempSteps .. " steps")
            end
            Rayfield:Notify({
                Title = "Success",
                Content = "glass_weak colored blue neon and detectors destroyed (crash-proof).",
                Duration = 3,
                Image = "rbxassetid://4483345998"
            })
        end

        -- Reset ESP
        local function resetGlassEsp()
            for part, props in pairs(originalTempered) do
                if part and part:IsDescendantOf(workspace) then
                    part.Color = props.Color
                    part.Material = props.Material
                end
            end
            originalTempered = {}
            cachedSteps = {}
            cachedTemperedParts = {}
        end

        -- Toggle ESP
        function toggleGlassEsp()
            glassEspEnabled = not glassEspEnabled
            if GlassEspToggle then GlassEspToggle:Set(glassEspEnabled) end
            if glassEspEnabled then
                pcall(function()
                    updateEspCache()
                    applyCachedEsp()
                end)
                if espStroke then
                    espStroke.Color = Color3.fromRGB(0, 255, 0)
                end
                Rayfield:Notify({
                    Title = "Success",
                    Content = "glass_tempered (neon green) enabled (crash-proof, auto-reapply).",
                    Duration = 3,
                    Image = "rbxassetid://4483345998"
                })
            else
                pcall(function()
                    resetGlassEsp()
                end)
                if espStroke then
                    espStroke.Color = Color3.fromRGB(0, 0, 0)
                end
                Rayfield:Notify({
                    Title = "Reset",
                    Content = "glass_tempered reset to original colors.",
                    Duration = 3,
                    Image = "rbxassetid://4483345998"
                })
            end
        end

        -- Floating ESP button
        local function createFloatingEspButton()
            if floatingEspButton then return end
            local screenGui = Instance.new("ScreenGui")
            screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
            screenGui.IgnoreGuiInset = true
            screenGui.ResetOnSpawn = false
            floatingEspButton = Instance.new("Frame")
            floatingEspButton.Size = UDim2.new(0, 50, 0, 50)
            floatingEspButton.Position = UDim2.new(0.4, 0, 0.5, 0)
            floatingEspButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            floatingEspButton.BorderSizePixel = 0
            floatingEspButton.Parent = screenGui
            local uiCorner = Instance.new("UICorner")
            uiCorner.CornerRadius = UDim.new(1, 0)
            uiCorner.Parent = floatingEspButton
            espStroke = Instance.new("UIStroke")
            espStroke.Thickness = 2
            espStroke.Color = glassEspEnabled and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(0, 0, 0)
            espStroke.Parent = floatingEspButton
            local textLabel = Instance.new("TextLabel")
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = "ESP"
            textLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
            textLabel.TextSize = 14
            textLabel.Font = Enum.Font.SourceSansBold
            textLabel.Parent = floatingEspButton
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, 0, 1, 0)
            button.BackgroundTransparency = 1
            button.Text = ""
            button.Parent = floatingEspButton
            button.MouseButton1Click:Connect(toggleGlassEsp)
            local dragging = false
            local dragInput, dragStart, startPos
            local function update(input)
                local delta = input.Position - dragStart
                floatingEspButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
            button.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    dragStart = input.Position
                    startPos = floatingEspButton.Position
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            dragging = false
                        end
                    end)
                end
            end)
            button.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
                    dragInput = input
                end
            end)
            UserInputService.InputChanged:Connect(function(input)
                if input == dragInput and dragging then
                    update(input)
                end
            end)
        end

        -- Floating Correct All button
        local function createFloatingCorrectButton()
            if floatingCorrectButton then return end
            local screenGui = Instance.new("ScreenGui")
            screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
            screenGui.IgnoreGuiInset = true
            screenGui.ResetOnSpawn = false
            floatingCorrectButton = Instance.new("Frame")
            floatingCorrectButton.Size = UDim2.new(0, 50, 0, 50)
            floatingCorrectButton.Position = UDim2.new(0.6, 0, 0.5, 0)
            floatingCorrectButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            floatingCorrectButton.BorderSizePixel = 0
            floatingCorrectButton.Parent = screenGui
            local uiCorner = Instance.new("UICorner")
            uiCorner.CornerRadius = UDim.new(1, 0)
            uiCorner.Parent = floatingCorrectButton
            correctStroke = Instance.new("UIStroke")
            correctStroke.Thickness = 2
            correctStroke.Color = Color3.fromRGB(0, 0, 0)
            correctStroke.Parent = floatingCorrectButton
            local textLabel = Instance.new("TextLabel")
            textLabel.Size = UDim2.new(1, 0, 1, 0)
            textLabel.BackgroundTransparency = 1
            textLabel.Text = "ALL"
            textLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
            textLabel.TextSize = 14
            textLabel.Font = Enum.Font.SourceSansBold
            textLabel.Parent = floatingCorrectButton
            local button = Instance.new("TextButton")
            button.Size = UDim2.new(1, 0, 1, 0)
            button.BackgroundTransparency = 1
            button.Text = ""
            button.Parent = floatingCorrectButton
            button.MouseButton1Click:Connect(function()
                executeCorrectAll()
                correctStroke.Color = Color3.fromRGB(0, 255, 0)
                task.wait(0.5)
                correctStroke.Color = Color3.fromRGB(0, 0, 0)
            end)
            local dragging = false
            local dragInput, dragStart, startPos
            local function update(input)
                local delta = input.Position - dragStart
                floatingCorrectButton.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
            button.InputBegan:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    dragStart = input.Position
                    startPos = floatingCorrectButton.Position
                    input.Changed:Connect(function()
                        if input.UserInputState == Enum.UserInputState.End then
                            dragging = false
                        end
                    end)
                end
            end)
            button.InputChanged:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
                    dragInput = input
                end
            end)
            UserInputService.InputChanged:Connect(function(input)
                if input == dragInput and dragging then
                    update(input)
                end
            end)
        end

        -- Destroy functions
        local function destroyFloatingEspButton()
            if floatingEspButton then
                floatingEspButton.Parent:Destroy()
                floatingEspButton = nil
                espStroke = nil
            end
        end

        local function destroyFloatingCorrectButton()
            if floatingCorrectButton then
                floatingCorrectButton.Parent:Destroy()
                floatingCorrectButton = nil
                correctStroke = nil
            end
        end

        -- Recreate on respawn
        LocalPlayer.CharacterAdded:Connect(function()
            task.wait(2)
            if floatingEspButtonToggle and floatingEspButtonToggle.CurrentValue then
                createFloatingEspButton()
            end
            if floatingCorrectButtonToggle and floatingCorrectButtonToggle.CurrentValue then
                createFloatingCorrectButton()
            end
            if glassEspEnabled then
                pcall(function()
                    updateEspCache()
                    applyCachedEsp()
                end)
            end
        end)

        -- =================== TAB: MAIN ===================
        local TabMain = Window:CreateTab("Main", "layers")
        TabMain:CreateSection("Glass Coloring")
        GlassEspToggle = TabMain:CreateToggle({
            Name = "Glass ESP",
            CurrentValue = false,
            Flag = "Glass_ESP",
            Callback = function(v)
                glassEspEnabled = v
                toggleGlassEsp()
            end,
        })

        TabMain:CreateSection("Correct All")
        TabMain:CreateButton({
            Name = "Execute Correct All",
            Callback = executeCorrectAll
        })

        TabMain:CreateSection("Debug")
        DebugLagToggle = TabMain:CreateToggle({
            Name = "Debug Lag (Console Times)",
            CurrentValue = false,
            Flag = "Debug_Lag",
            Callback = function() end
        })

        TabMain:CreateSection("Configuration")
        TabMain:CreateLabel("Settings save manually. Crash-proof, auto-reapply ESP for ~18 Steps.")

        -- ================= TAB: MOBILE =================
        local TabMobile = Window:CreateTab("Mobile", "smartphone")
        TabMobile:CreateSection("Floating Buttons")
        floatingEspButtonToggle = TabMobile:CreateToggle({
            Name = "ESP Button",
            CurrentValue = false,
            Flag = "Floating_ESP_Button",
            Callback = function(v)
                if v then
                    createFloatingEspButton()
                    Rayfield:Notify({ Title = "Success", Content = "ESP floating button enabled.", Duration = 3, Image = "rbxassetid://4483345998" })
                else
                    destroyFloatingEspButton()
                    Rayfield:Notify({ Title = "Success", Content = "ESP floating button disabled.", Duration = 3, Image = "rbxassetid://4483345998" })
                end
            end,
        })

        floatingCorrectButtonToggle = TabMobile:CreateToggle({
            Name = "Correct All Button",
            CurrentValue = false,
            Flag = "Floating_Correct_Button",
            Callback = function(v)
                if v then
                    createFloatingCorrectButton()
                    Rayfield:Notify({ Title = "Success", Content = "Correct All floating button enabled.", Duration = 3, Image = "rbxassetid://4483345998" })
                else
                    destroyFloatingCorrectButton()
                    Rayfield:Notify({ Title = "Success", Content = "Correct All floating button disabled.", Duration = 3, Image = "rbxassetid://4483345998" })
                end
            end,
        })

        -- ================= TAB: KEYBINDS =================
        local TabKeys = Window:CreateTab("Keybinds", "keyboard")
        TabKeys:CreateSection("Custom Keybinds")
        TabKeys:CreateKeybind({
            Name = "Toggle Glass ESP",
            CurrentKeybind = "E",
            HoldToInteract = false,
            Flag = "Keybind_GlassESP",
            Callback = toggleGlassEsp
        })
        TabKeys:CreateKeybind({
            Name = "Execute Correct All",
            CurrentKeybind = "R",
            HoldToInteract = false,
            Flag = "Keybind_CorrectAll",
            Callback = executeCorrectAll
        })
        TabKeys:CreateLabel("Press G to open/close the menu")
        TabKeys:CreateLabel("Default: E for Glass ESP, R for Correct All")

        -- ================== CREDITS ==================
        local TabCredits = Window:CreateTab("Credits", "award")
        TabCredits:CreateSection("Script Information")
        TabCredits:CreateLabel("Glass Color Menu | Made by Estardax ⚡ (Crash-Proof Edition)")
        TabCredits:CreateLabel("UI powered by Rayfield Library")
        TabCredits:CreateLabel("Scriptax HUB - Advanced Glass Bridge Tools")

        return Window
    end

    -- Initial creation
    createWindow()
end
